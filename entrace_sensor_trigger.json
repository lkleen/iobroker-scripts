/* -- do not edit following lines - START --
{
  "expert": true,
  "debug": false,
  "verbose": false
}
-- do not edit previous lines - END --*/
var sensorControlId = 'scene.0.sensor.hall.on';
var sensorId = 'deconz.0.Sensors.16.presence';

var light1Id = 'deconz.0.Lights.3.on';
var light2Id = 'deconz.0.Lights.4.on';

var morningState = 'scene.0.hall.nightlight';
var dayState = 'scene.0.hall.on';
var eveningState = 'scene.0.hall.nightlight';
var nightState = 'scene.0.hall.nightlight';
var offState = 'scene.0.hall.off';

var offDelay = 1000; //5 * 60000;

var logLevel = 'info';

var isSensorOn = function () {return getState(sensorControlId).val};

var presenceTrigger = {id: sensorId, val: true}; /* presence trigger */
var absenseTrigger  = {id: sensorId, val: false}; /* absense trigger */

var isHallLightOn = function () {return getState(light1Id).val || getState(light2Id).val};
var isOnByMotion = false;

var lightsOnCondition = function () {
    if (isHallLightOn ()) {return false;}
    return isSensorOn ();
}

var localTime = new LocalTime ();
localTime.getPeriod ();

var turnOffDelay = offDelay;
var turnOffTimer = new Timer ();

 //log(JSON.stringify(date));

 var turnOnLight = function (period) {
     switch (period)
     {
        case Periods.MORNING: setState (morningState, true, null); break;
        case Periods.DAY: setState (dayState, true, null); break;
        case Periods.EVENING: setState (eveningState, true, null); break;
        case Periods.NIGHT: setState (nightState, true, null); break;
     }
    log('turn on light:' + period.name, logLevel);
    isOnByMotion = true;     
 };

on(presenceTrigger, function (obj) {
  log('presence: true, elapsed: ' + turnOffTimer.getElapsedMilliseconds (), logLevel);
  turnOffTimer.reset ();
  if (lightsOnCondition ()) {
    turnOnLight (localTime.getPeriod ());
  }
});

on(absenseTrigger, function (obj) {
    log('presence: false, elapsed: ' + turnOffTimer.getElapsedMilliseconds (), logLevel);
    if (!isOnByMotion || !isHallLightOn ()) {
        return;
    }

    if (turnOffTimer.isElapsed(turnOffDelay)) {
        isOnByMotion = false;
        setState (offState, true, null);
    }
});